<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글러브 마켓 전체 제품 대시보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        /* 상단 통계 카드 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
        }

        /* 크롤링 버튼 섹션 */
        .button-section {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .all-btn {
            background: linear-gradient(135deg, #56ab2f, #a8e063);
            color: white;
            border: 1px solid #56ab2f;
        }

        .all-btn:hover {
            background: linear-gradient(135deg, #4a9527, #96d254);
            transform: translateY(-2px);
        }

        .yahoo-btn {
            background: #667eea;
            color: white;
            border: 1px solid #667eea;
        }

        .yahoo-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .action-btn.active {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .yayongsa-btn {
            background: #764ba2;
            color: white;
            border: 2px solid #764ba2;
        }

        .yayongsa-btn:hover {
            background: #654290;
            color: white;
        }

        .sync-btn {
            background: #48bb78;
            color: white;
            border: 2px solid #48bb78;
        }

        .sync-btn:hover {
            background: #38a169;
        }

        /* 필터 섹션 */
        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-section label {
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-select:focus {
            border-color: #667eea;
            outline: none;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            border-color: #667eea;
            outline: none;
        }

        .filter-btn {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: 1px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        /* 제품 정보 */
        .product-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            color: #333;
            font-size: 14px;
        }

        .page-info {
            margin-left: auto;
        }

        /* 제품 그리드 */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f5f5f5;
        }

        .product-content {
            padding: 15px;
        }

        .product-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
            height: 2.8em;
        }

        .product-price {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .product-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 12px;
            color: #999;
        }

        .product-meta span {
            padding: 2px 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        /* 페이지네이션 */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 30px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        /* Statistics Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            padding: 5px;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        .stats-section {
            margin-bottom: 30px;
        }

        .stats-section h3 {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-item .label {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 200px;
            margin-bottom: 10px;
        }

        .bar {
            width: 60px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s;
        }

        .bar:hover {
            transform: scale(1.05);
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #666;
            width: 80px;
            text-align: center;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚾ 글러브 마켓 전체 제품 대시보드</h1>

        <!-- 통계 카드 -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="label">Yahoo 총 상품</div>
                <div class="value">{{ yahoo_count|default(0) }}</div>
            </div>
            <div class="stat-card">
                <div class="label">야용사 총 상품</div>
                <div class="value">{{ yayongsa_count|default(0) }}</div>
            </div>
            <div class="stat-card">
                <div class="label">Yahoo 평균가격</div>
                <div class="value">￥{{ "{:,}".format(yahoo_avg|default(0)|int) }}</div>
            </div>
            <div class="stat-card">
                <div class="label">Daum 평균가격</div>
                <div class="value">₩{{ "{:,}".format(yayongsa_avg|default(0)|int) }}</div>
            </div>
        </div>

        <!-- 버튼 섹션 -->
        <div class="button-section">
            <button class="action-btn all-btn" onclick="filterProductsBySource('all')">모든 마켓 ({{ yahoo_count + yayongsa_count }}개)</button>
            <button class="action-btn yahoo-btn" onclick="filterProductsBySource('yahoo')">Yahoo Auction ({{ yahoo_count }}개)</button>
            <button class="action-btn daum-btn" onclick="filterProductsBySource('yayongsa')">야용사 카페 ({{ yayongsa_count }}개)</button>
            <button class="action-btn sync-btn" onclick="showStatisticsModal()">📊 통계 분석</button>
        </div>

        <!-- 다운로드 버튼 -->
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="/dashboard/export" class="btn btn-success" style="padding: 10px 20px; font-weight: 600; background: #48bb78; border: none; border-radius: 8px; color: white; text-decoration: none; display: inline-block;">
                📥 Excel 다운로드
            </a>
        </div>

        <!-- 필터 섹션 -->
        <div class="filter-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="브랜드나 제품명 검색 (예: Mizuno, Rawlings)" onkeyup="filterProducts()">
            </div>
            <select class="filter-select" id="positionSelect" onchange="filterProducts()">
                <option value="all">모든 포지션</option>
                <option value="투수">투수用</option>
                <option value="외야수">외야수用</option>
                <option value="내야수">내야수用</option>
                <option value="포수">포수用</option>
                <option value="올라운드">올라운드</option>
            </select>
            <select class="filter-select" id="conditionSelect" onchange="filterProducts()">
                <option value="all">모든 상태</option>
                <option value="신품">新品 (신품)</option>
                <option value="중고">中古 (중고)</option>
            </select>
            <select class="filter-select" id="typeSelect" onchange="filterProducts()">
                <option value="all">모든 타입</option>
                <option value="hardball">硬式 (경식)</option>
                <option value="softball">軟式 (연식)</option>
            </select>
            <select class="filter-select" id="brandSelect" onchange="filterProducts()">
                <option value="all">모든 브랜드</option>
                <option value="mizuno">Mizuno</option>
                <option value="zett">ZETT</option>
                <option value="ssk">SSK</option>
                <option value="rawlings">Rawlings</option>
                <option value="wilson">Wilson</option>
                <option value="asics">ASICS</option>
                <option value="nike">Nike</option>
                <option value="other">その他</option>
            </select>
            <select class="filter-select" id="marketSelect" onchange="filterProducts()">
                <option value="all">모든 마켓</option>
                <option value="yahoo">Yahoo</option>
                <option value="yayongsa">야용사</option>
            </select>
            <button class="filter-btn" onclick="resetFilters()">필터 초기화</button>
        </div>

        <!-- 제품 정보 -->
        <div class="product-info">
            <span id="productInfoText">표시 중: 1-20 / 전체 0개</span>
            <span class="page-info">페이지당:
                <select id="pageSizeSelect" onchange="changePageSize(this.value)">
                    <option value="20" selected>20개</option>
                    <option value="50">50개</option>
                    <option value="100">100개</option>
                    <option value="200">200개</option>
                </select>
            </span>
        </div>

        <!-- 제품 그리드 -->
        <div class="products-grid" id="productsGrid">
            <!-- 제품 카드들이 여기에 동적으로 로드됩니다 -->
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination" id="paginationContainer">
            <!-- 페이지 버튼들이 여기에 동적으로 생성됩니다 -->
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span>📊</span> 상세 통계 분석</h2>
                <button class="modal-close" onclick="closeStatsModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Overall Statistics -->
                <div class="stats-section">
                    <h3>전체 통계</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="label">전체 상품 수</div>
                            <div class="value" id="totalProductsStat">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">평균 가격</div>
                            <div class="value" id="avgPriceStat">¥0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">최고가</div>
                            <div class="value" id="maxPriceStat">¥0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">최저가</div>
                            <div class="value" id="minPriceStat">¥0</div>
                        </div>
                    </div>
                </div>

                <!-- Brand Statistics -->
                <div class="stats-section">
                    <h3>브랜드별 분포</h3>
                    <div class="chart-container">
                        <div class="bar-chart" id="brandChart"></div>
                    </div>
                </div>

                <!-- Position Statistics -->
                <div class="stats-section">
                    <h3>포지션별 통계</h3>
                    <div class="stats-grid" id="positionStats">
                    </div>
                </div>

                <!-- Condition Statistics -->
                <div class="stats-section">
                    <h3>상태별 분포</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="label">신품</div>
                            <div class="value" id="newCountStat">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">중고</div>
                            <div class="value" id="usedCountStat">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">신품 평균가</div>
                            <div class="value" id="newAvgPriceStat">¥0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">중고 평균가</div>
                            <div class="value" id="usedAvgPriceStat">¥0</div>
                        </div>
                    </div>
                </div>

                <!-- Market Statistics -->
                <div class="stats-section">
                    <h3>마켓별 통계</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="label">Yahoo Auction</div>
                            <div class="value" id="yahooCountStat">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">야용사 카페</div>
                            <div class="value" id="yayongsaCountStat">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">Yahoo 평균가</div>
                            <div class="value" id="yahooAvgPriceStat">¥0</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">야용사 평균가</div>
                            <div class="value" id="yayongsaAvgPriceStat">₩0</div>
                        </div>
                    </div>
                </div>

                <!-- Price Range Distribution -->
                <div class="stats-section">
                    <h3>가격대별 분포</h3>
                    <div class="chart-container">
                        <div class="bar-chart" id="priceRangeChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수로 제품 데이터 저장
        let allProducts = {{ products | tojson | safe }};
        let filteredProducts = [...allProducts];
        console.log('=== INITIAL DATA LOAD ===');
        console.log('Loaded products count:', allProducts.length);
        console.log('First product:', allProducts[0]);

        // 데이터가 없는 경우 확인
        if (allProducts.length === 0) {
            console.error('WARNING: No products loaded!');
        } else {
            console.log('Sample products:', allProducts.slice(0, 3));

            // 마켓별 카운트 확인
            const yahooCount = allProducts.filter(p => p.market === 'Yahoo').length;
            const yayongsaCount = allProducts.filter(p => p.market === 'Yayongsa').length;
            console.log('Yahoo products:', yahooCount);
            console.log('Yayongsa products:', yayongsaCount);
        }

        // 페이지네이션 변수
        let currentPage = 1;
        let pageSize = 24;  // 한 페이지당 24개 제품

        // 제품 데이터 분석하여 추가 정보 추출 (한글 데이터 유지)
        function analyzeProduct(product) {
            // 이미 한글 데이터가 있으면 그대로 사용
            if (product.position && product.condition) {
                return product;
            }

            const title = product.title || '';
            const titleLower = title.toLowerCase();

            // 포지션 분석 (한글로 저장)
            let position = product.position || '올라운드';
            if (!product.position) {
                if (title.includes('投手') || titleLower.includes('pitcher') || title.includes('ピッチャー')) {
                    position = '투수';
                } else if (title.includes('外野') || titleLower.includes('outfield') || title.includes('アウトフィルダー')) {
                    position = '외야수';
                } else if (title.includes('内野') || titleLower.includes('infield') || title.includes('インフィルダー')) {
                    position = '내야수';
                } else if (title.includes('捕手') || titleLower.includes('catcher') || title.includes('キャッチャー')) {
                    position = '포수';
                }
            }

            // 상태 분석 (신품/중고) - 한글로 저장
            let condition = product.condition || '중고';
            if (!product.condition) {
                if (title.includes('新品') || title.includes('未使用') || titleLower.includes('new')) {
                    condition = '신품';
                }
            }

            // 타입 분석 (경식/연식)
            let type = '경식';
            if (title.includes('軟式') || titleLower.includes('softball')) {
                type = '연식';
            }

            // 브랜드 분석 (이미 있으면 그대로 사용)
            let brand = product.brand || '기타';
            if (!product.brand || product.brand === 'その他') {
                if (titleLower.includes('mizuno') || title.includes('ミズノ')) {
                    brand = 'Mizuno';
                } else if (titleLower.includes('zett') || title.includes('ゼット')) {
                    brand = 'ZETT';
                } else if (titleLower.includes('ssk') || title.includes('エスエスケイ')) {
                    brand = 'SSK';
                } else if (titleLower.includes('rawlings') || title.includes('ローリングス')) {
                    brand = 'Rawlings';
                } else if (titleLower.includes('wilson') || title.includes('ウィルソン')) {
                    brand = 'Wilson';
                } else if (titleLower.includes('asics') || title.includes('アシックス')) {
                    brand = 'ASICS';
                } else if (titleLower.includes('nike') || title.includes('ナイキ')) {
                    brand = 'Nike';
                }
            }

            // 마켓 정보 그대로 유지
            const market = product.market || 'Yahoo';

            return { ...product, position, condition, type, brand, market };
        }

        // 모든 제품 분석
        allProducts = allProducts.map(analyzeProduct);
        filteredProducts = [...allProducts];

        // 제품 표시 함수
        function displayProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';

            // 페이지네이션 계산
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedProducts = filteredProducts.slice(startIndex, endIndex);

            if (paginatedProducts.length === 0 && currentPage > 1) {
                currentPage = 1;
                displayProducts();
                return;
            }

            if (paginatedProducts.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">검색 결과가 없습니다.</div>';
            }

            paginatedProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => {
                    if (product.url && product.url !== '#') {
                        window.open(product.url, '_blank');
                    }
                };

                // 이미지 처리 - 썸네일 우선, 없으면 기본 이미지
                let imageHtml = '<div class="product-image" style="background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999;">No Image</div>';
                if (product.image && product.image !== '') {
                    imageHtml = `<img src="${product.image}" class="product-image" alt="${product.title}" onerror="this.onerror=null; this.src=''; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'product-image\\' style=\\'background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999;\\'>No Image</div>';">`;
                }

                // 가격 표시
                const priceDisplay = product.price || '가격 정보 없음';

                // 포지션, 상태, 타입은 이미 한글로 되어 있음
                const positionKr = product.position || '올라운드';
                const conditionKr = product.condition || '중고';
                const typeKr = product.type || '경식';

                card.innerHTML = `
                    ${imageHtml}
                    <div class="product-content">
                        <div class="product-title">${product.title}</div>
                        <div class="product-price">${priceDisplay}</div>
                        <div class="product-meta">
                            <span>${positionKr}</span>
                            <span>${conditionKr}</span>
                            <span>${typeKr}</span>
                            <span>${product.brand || '기타'}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            // 표시 중인 제품 수 업데이트
            const totalProducts = filteredProducts.length;
            const showingStart = totalProducts > 0 ? startIndex + 1 : 0;
            const showingEnd = Math.min(endIndex, totalProducts);
            const infoElement = document.getElementById('productInfoText');
            if (infoElement) {
                infoElement.textContent = `표시 중: ${showingStart}-${showingEnd} / 전체 ${totalProducts}개`;
            }

            // 페이지네이션 버튼 업데이트
            updatePagination();
        }

        // 필터링 함수
        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const positionFilter = document.getElementById('positionSelect').value;
            const conditionFilter = document.getElementById('conditionSelect').value;
            const typeFilter = document.getElementById('typeSelect').value;
            const brandFilter = document.getElementById('brandSelect').value;
            const marketFilter = document.getElementById('marketSelect').value;

            filteredProducts = allProducts.filter(product => {
                // 검색어 필터 (제목과 브랜드에서 검색)
                if (searchTerm) {
                    const titleMatch = product.title && product.title.toLowerCase().includes(searchTerm);
                    const brandMatch = product.brand && product.brand.toLowerCase().includes(searchTerm);
                    if (!titleMatch && !brandMatch) {
                        return false;
                    }
                }
                // 포지션 필터 (한글 직접 비교)
                if (positionFilter !== 'all') {
                    if (product.position !== positionFilter) {
                        return false;
                    }
                }
                // 상태 필터 (한글 직접 비교)
                if (conditionFilter !== 'all') {
                    if (product.condition !== conditionFilter) {
                        return false;
                    }
                }
                // 타입 필터 (한글 직접 비교)
                if (typeFilter !== 'all') {
                    if (product.type !== typeFilter) {
                        return false;
                    }
                }
                // 브랜드 필터
                if (brandFilter !== 'all') {
                    if (product.brand !== brandFilter) {
                        return false;
                    }
                }
                // 마켓 필터
                if (marketFilter !== 'all') {
                    if (product.market !== marketFilter) {
                        return false;
                    }
                }
                return true;
            });

            currentPage = 1;
            displayProducts();
        }

        // 필터 초기화
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('positionSelect').value = 'all';
            document.getElementById('conditionSelect').value = 'all';
            document.getElementById('typeSelect').value = 'all';
            document.getElementById('brandSelect').value = 'all';
            document.getElementById('marketSelect').value = 'all';
            filteredProducts = [...allProducts];
            currentPage = 1;
            displayProducts();
        }

        // 페이지 로드 시 제품 표시 및 모든 마켓 선택
        window.onload = function() {
            displayProducts();
            // 초기 로드 시 "모든 마켓" 버튼 활성화
            document.querySelector('.all-btn').classList.add('active');
        };

        function filterProductsBySource(source) {
            console.log('Filtering by source:', source);
            console.log('All products:', allProducts.length);
            console.log('Sample markets:', allProducts.slice(0, 5).map(p => p.market));

            // 모든 버튼에서 active 클래스 제거
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (source === 'yahoo') {
                filteredProducts = allProducts.filter(p => p.market === 'Yahoo');
                console.log('Yahoo filtered:', filteredProducts.length);
                document.querySelector('.yahoo-btn').classList.add('active');
            } else if (source === 'yayongsa') {
                filteredProducts = allProducts.filter(p => p.market === 'Yayongsa');
                console.log('Yayongsa filtered:', filteredProducts.length);
                // 야용사 제품 디버깅
                const yayongsaProducts = allProducts.filter(p => p.market === 'Yayongsa');
                console.log('Yayongsa products found:', yayongsaProducts);
                document.querySelector('.daum-btn').classList.add('active');
            } else {
                filteredProducts = [...allProducts];
                console.log('All markets:', filteredProducts.length);
                document.querySelector('.all-btn').classList.add('active');
            }
            currentPage = 1;
            displayProducts();
        }



        function showStatisticsModal() {
            console.log('=== showStatisticsModal called ===');
            console.log('allProducts:', allProducts);
            console.log('allProducts.length:', allProducts.length);
            console.log('filteredProducts:', filteredProducts);
            console.log('filteredProducts.length:', filteredProducts.length);

            const modal = document.getElementById('statsModal');
            modal.classList.add('show');
            calculateStatistics();
        }

        function closeStatsModal() {
            const modal = document.getElementById('statsModal');
            modal.classList.remove('show');
        }

        function calculateStatistics() {
            console.log('calculateStatistics called with', filteredProducts.length, 'products');

            // Calculate overall statistics
            const totalProducts = filteredProducts.length;
            document.getElementById('totalProductsStat').textContent = totalProducts.toLocaleString();

            // 전체 제품이 없으면 기본값 설정
            if (totalProducts === 0) {
                document.getElementById('avgPriceStat').textContent = '¥0';
                document.getElementById('maxPriceStat').textContent = '¥0';
                document.getElementById('minPriceStat').textContent = '¥0';
                document.getElementById('yahooCountStat').textContent = '0';
                document.getElementById('yayongsaCountStat').textContent = '0';
                document.getElementById('yahooAvgPriceStat').textContent = '¥0';
                document.getElementById('yayongsaAvgPriceStat').textContent = '₩0';
                document.getElementById('newCountStat').textContent = '0';
                document.getElementById('usedCountStat').textContent = '0';
                document.getElementById('newAvgPriceStat').textContent = '¥0';
                document.getElementById('usedAvgPriceStat').textContent = '¥0';

                // 차트 초기화
                document.getElementById('brandChart').innerHTML = '<p style="text-align: center; color: #999;">데이터가 없습니다</p>';
                document.getElementById('positionStats').innerHTML = '<p style="text-align: center; color: #999;">데이터가 없습니다</p>';
                document.getElementById('priceRangeChart').innerHTML = '<p style="text-align: center; color: #999;">데이터가 없습니다</p>';
                return;
            }

            // 마켓별 통계 계산
            const yahooProducts = filteredProducts.filter(p => p.market === 'Yahoo');
            const yayongsaProducts = filteredProducts.filter(p => p.market === 'Yayongsa');

            console.log('통계 계산 - Yahoo:', yahooProducts.length, 'Yayongsa:', yayongsaProducts.length);

            // 마켓별 상품 수 표시
            document.getElementById('yahooCountStat').textContent = yahooProducts.length;
            document.getElementById('yayongsaCountStat').textContent = yayongsaProducts.length;

            // Calculate prices (Yahoo는 엔화, Yayongsa는 원화)
            const yahooPrices = yahooProducts.map(p => {
                if (p.current_price) {
                    return p.current_price;
                } else if (p.price) {
                    const priceStr = p.price.replace(/[^0-9]/g, '');
                    return parseInt(priceStr) || 0;
                }
                return 0;
            }).filter(p => p > 0);

            const yayongsaPrices = yayongsaProducts.map(p => {
                if (p.current_price) {
                    return p.current_price;
                } else if (p.price) {
                    const priceStr = p.price.replace(/[^0-9]/g, '');
                    return parseInt(priceStr) || 0;
                }
                return 0;
            }).filter(p => p > 0);

            // 전체 가격 (Yahoo 기준으로 통일)
            const prices = filteredProducts.map(p => {
                if (p.current_price) {
                    return p.current_price;
                } else if (p.price) {
                    const priceStr = p.price.replace(/[^0-9]/g, '');
                    return parseInt(priceStr) || 0;
                }
                return 0;
            }).filter(p => p > 0);

            if (prices.length > 0) {
                const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
                const maxPrice = Math.max(...prices);
                const minPrice = Math.min(...prices);

                // 현재 필터된 제품이 주로 어느 마켓인지 확인
                const currency = yahooProducts.length > yayongsaProducts.length ? '¥' : '₩';
                document.getElementById('avgPriceStat').textContent = currency + avgPrice.toLocaleString();
                document.getElementById('maxPriceStat').textContent = currency + maxPrice.toLocaleString();
                document.getElementById('minPriceStat').textContent = currency + minPrice.toLocaleString();
            }

            // 마켓별 평균가 계산
            if (yahooPrices.length > 0) {
                const yahooAvg = Math.round(yahooPrices.reduce((a, b) => a + b, 0) / yahooPrices.length);
                document.getElementById('yahooAvgPriceStat').textContent = '¥' + yahooAvg.toLocaleString();
            } else {
                document.getElementById('yahooAvgPriceStat').textContent = '¥0';
            }

            if (yayongsaPrices.length > 0) {
                const yayongsaAvg = Math.round(yayongsaPrices.reduce((a, b) => a + b, 0) / yayongsaPrices.length);
                document.getElementById('yayongsaAvgPriceStat').textContent = '₩' + yayongsaAvg.toLocaleString();
            } else {
                document.getElementById('yayongsaAvgPriceStat').textContent = '₩0';
            }

            // Calculate brand distribution
            const brandCounts = {};
            filteredProducts.forEach(product => {
                const brand = product.brand || '기타';  // 한글로 변경
                brandCounts[brand] = (brandCounts[brand] || 0) + 1;
            });

            // Display top brands as bar chart
            const brandChart = document.getElementById('brandChart');
            brandChart.innerHTML = '';
            const topBrands = Object.entries(brandCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);

            console.log('Brand counts:', brandCounts);
            console.log('Top brands:', topBrands);

            if (topBrands.length > 0) {
                const maxCount = Math.max(...topBrands.map(b => b[1]));
                topBrands.forEach(([brand, count]) => {
                    const barHeight = Math.max(20, (count / maxCount) * 180);  // 최소 높이 20px
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = barHeight + 'px';
                    bar.innerHTML = `
                        <span class="bar-value">${count}</span>
                        <span class="bar-label">${brand}</span>
                    `;
                    brandChart.appendChild(bar);
                });
            } else {
                brandChart.innerHTML = '<p style="text-align: center; color: #999;">브랜드 데이터가 없습니다</p>';
            }

            // Calculate position statistics
            const positionCounts = {};
            filteredProducts.forEach(product => {
                const position = product.position || '올라운드';  // 한글로 변경
                positionCounts[position] = (positionCounts[position] || 0) + 1;
            });

            const positionStats = document.getElementById('positionStats');
            positionStats.innerHTML = '';

            console.log('Position counts:', positionCounts);

            if (Object.keys(positionCounts).length > 0) {
                Object.entries(positionCounts).forEach(([position, count]) => {
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';
                    statItem.innerHTML = `
                        <div class="label">${position}</div>
                        <div class="value">${count}</div>
                    `;
                    positionStats.appendChild(statItem);
                });
            } else {
                positionStats.innerHTML = '<p style="text-align: center; color: #999;">포지션 데이터가 없습니다</p>';
            }

            // Calculate condition statistics
            const newProducts = filteredProducts.filter(p => p.condition === '신품');
            const usedProducts = filteredProducts.filter(p => p.condition === '중고');

            document.getElementById('newCountStat').textContent = newProducts.length;
            document.getElementById('usedCountStat').textContent = usedProducts.length;

            // Calculate average prices by condition
            const newPrices = newProducts.map(p => {
                if (p.current_price) {
                    return p.current_price;
                } else if (p.price) {
                    const priceStr = p.price.replace(/[^0-9]/g, '');
                    return parseInt(priceStr) || 0;
                }
                return 0;
            }).filter(p => p > 0);

            const usedPrices = usedProducts.map(p => {
                if (p.current_price) {
                    return p.current_price;
                } else if (p.price) {
                    const priceStr = p.price.replace(/[^0-9]/g, '');
                    return parseInt(priceStr) || 0;
                }
                return 0;
            }).filter(p => p > 0);

            if (newPrices.length > 0) {
                const newAvg = Math.round(newPrices.reduce((a, b) => a + b, 0) / newPrices.length);
                document.getElementById('newAvgPriceStat').textContent = '¥' + newAvg.toLocaleString();
            }

            if (usedPrices.length > 0) {
                const usedAvg = Math.round(usedPrices.reduce((a, b) => a + b, 0) / usedPrices.length);
                document.getElementById('usedAvgPriceStat').textContent = '¥' + usedAvg.toLocaleString();
            }

            // Calculate price range distribution
            const priceRanges = {
                '~10,000': 0,
                '10,001~20,000': 0,
                '20,001~30,000': 0,
                '30,001~50,000': 0,
                '50,001~100,000': 0,
                '100,000+': 0
            };

            prices.forEach(price => {
                if (price <= 10000) priceRanges['~10,000']++;
                else if (price <= 20000) priceRanges['10,001~20,000']++;
                else if (price <= 30000) priceRanges['20,001~30,000']++;
                else if (price <= 50000) priceRanges['30,001~50,000']++;
                else if (price <= 100000) priceRanges['50,001~100,000']++;
                else priceRanges['100,000+']++;
            });

            // Display price range chart
            const priceRangeChart = document.getElementById('priceRangeChart');
            priceRangeChart.innerHTML = '';

            const validRanges = Object.entries(priceRanges).filter(([_, count]) => count > 0);
            console.log('Price ranges:', priceRanges);
            console.log('Valid price ranges:', validRanges);

            if (validRanges.length > 0) {
                const maxRangeCount = Math.max(...validRanges.map(([_, count]) => count));

                validRanges.forEach(([range, count]) => {
                    const barHeight = Math.max(20, (count / maxRangeCount) * 180);  // 최소 높이 20px
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = barHeight + 'px';
                    bar.innerHTML = `
                        <span class="bar-value">${count}</span>
                        <span class="bar-label">¥${range}</span>
                    `;
                    priceRangeChart.appendChild(bar);
                });
            } else {
                priceRangeChart.innerHTML = '<p style="text-align: center; color: #999;">가격 데이터가 없습니다</p>';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('statsModal');
            if (event.target == modal) {
                closeStatsModal();
            }
        }

        // 페이지네이션 업데이트 함수
        function updatePagination() {
            const totalPages = Math.ceil(filteredProducts.length / pageSize);
            const paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) return;

            paginationContainer.innerHTML = '';

            if (totalPages <= 1) return;

            // 처음 버튼
            const firstBtn = document.createElement('button');
            firstBtn.textContent = '처음';
            firstBtn.onclick = () => goToPage(1);
            firstBtn.disabled = currentPage === 1;
            paginationContainer.appendChild(firstBtn);

            // 이전 버튼
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '이전';
            prevBtn.onclick = () => previousPage();
            prevBtn.disabled = currentPage === 1;
            paginationContainer.appendChild(prevBtn);

            // 페이지 번호 버튼들
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                if (i === currentPage) {
                    pageBtn.className = 'active';
                }
                paginationContainer.appendChild(pageBtn);
            }

            // 다음 버튼
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '다음';
            nextBtn.onclick = () => nextPage();
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            paginationContainer.appendChild(nextBtn);

            // 마지막 버튼
            const lastBtn = document.createElement('button');
            lastBtn.textContent = '마지막';
            lastBtn.onclick = () => goToLastPage();
            lastBtn.disabled = currentPage === totalPages || totalPages === 0;
            paginationContainer.appendChild(lastBtn);
        }

        function changePageSize(size) {
            pageSize = parseInt(size);
            currentPage = 1;
            displayProducts();
        }

        function goToPage(page) {
            currentPage = page;
            displayProducts();
            window.scrollTo(0, 0);
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayProducts();
                window.scrollTo(0, 0);
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredProducts.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayProducts();
                window.scrollTo(0, 0);
            }
        }

        function goToLastPage() {
            const totalPages = Math.ceil(filteredProducts.length / pageSize) || 1;
            currentPage = totalPages;
            displayProducts();
            window.scrollTo(0, 0);
        }

        // 야용사 크롤링 함수
        function startYayongsaCrawl() {
            // 크롤링 시작 확인
            if (confirm('야용사(다음 카페) 크롤링을 시작하시겠습니까?\n\n크롤링이 백그라운드에서 실행됩니다.\n잠시 후 결과를 확인해주세요.')) {
                // 크롤링 API 호출
                fetch('/api/crawl/yayongsa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                    } else {
                        alert('크롤링 시작 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('크롤링 요청 중 오류가 발생했습니다.');
                });
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('DOMContentLoaded', function() {
            displayProducts();
        });
    </script>
</body>
</html>