#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
ÌÜµÌï© ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÌÅ¨Î¶ΩÌä∏
Î™®Îì† ÌÅ¨Î°§ÎßÅ Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏßëÌïòÏó¨ ÌÜµÌï© ÎåÄÏãúÎ≥¥Îìú ÏÉùÏÑ±
"""

import json
import os
import glob
from datetime import datetime
from collections import defaultdict

def update_integrated_dashboard():
    """Î™®Îì† JSON ÌååÏùºÏùò Îç∞Ïù¥ÌÑ∞Î•º ÌÜµÌï©ÌïòÏó¨ ÎåÄÏãúÎ≥¥Îìú ÏÉùÏÑ±"""

    print("="*60)
    print("üìä ÌÜµÌï© ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏")
    print("="*60)

    # Î™®Îì† Yahoo Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
    yahoo_data = []
    yayongsa_data = []

    # Î™®Îì† ÏúÑÏπòÏóêÏÑú Yahoo Îç∞Ïù¥ÌÑ∞ ÌååÏùº Ï∞æÍ∏∞
    yahoo_patterns = [
        'yahoo_auction_*.json',
        'users/*/yahoo_auction_*.json',
        'users/*/data/yahoo_auction_*.json',
        'data/yahoo_auction_*.json'
    ]

    yahoo_files = []
    for pattern in yahoo_patterns:
        yahoo_files.extend(glob.glob(pattern, recursive=False))

    # Ï§ëÎ≥µ Ï†úÍ±∞
    yahoo_files = list(set(yahoo_files))

    print(f"\nüìÅ Î∞úÍ≤¨Îêú Yahoo ÌååÏùº: {len(yahoo_files)}Í∞ú")

    # Î™®Îì† Yahoo ÌååÏùº Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    for file_path in yahoo_files:
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                file_data = json.load(f)
                if isinstance(file_data, list):
                    yahoo_data.extend(file_data)
                    print(f"  ‚úÖ {os.path.basename(file_path)}: {len(file_data)}Í∞ú ÏÉÅÌíà")
        except Exception as e:
            print(f"  ‚ùå {os.path.basename(file_path)} Î°úÎìú Ïã§Ìå®: {e}")

    # ÏïºÏö©ÏÇ¨ Îç∞Ïù¥ÌÑ∞ ÌååÏùº Ï∞æÍ∏∞
    yayongsa_patterns = [
        'yayongsa_*.json',
        'glove_data_*.json',
        'sample_yayongsa_data.json',
        'users/*/yayongsa_*.json',
        'users/*/data/yayongsa_*.json',
        'users/*/data/glove_data_*.json'
    ]

    yayongsa_files = []
    for pattern in yayongsa_patterns:
        yayongsa_files.extend(glob.glob(pattern, recursive=False))

    yayongsa_files = list(set(yayongsa_files))

    print(f"\nüìÅ Î∞úÍ≤¨Îêú ÏïºÏö©ÏÇ¨ ÌååÏùº: {len(yayongsa_files)}Í∞ú")

    # Î™®Îì† ÏïºÏö©ÏÇ¨ ÌååÏùº Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    for file_path in yayongsa_files:
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                file_data = json.load(f)
                if isinstance(file_data, list):
                    yayongsa_data.extend(file_data)
                    print(f"  ‚úÖ {os.path.basename(file_path)}: {len(file_data)}Í∞ú ÏÉÅÌíà")
        except Exception as e:
            print(f"  ‚ùå {os.path.basename(file_path)} Î°úÎìú Ïã§Ìå®: {e}")

    print(f"\nüìä Ï¥ùÍ≥Ñ:")
    print(f"  Yahoo: {len(yahoo_data)}Í∞ú ÏÉÅÌíà")
    print(f"  ÏïºÏö©ÏÇ¨: {len(yayongsa_data)}Í∞ú ÏÉÅÌíà")
    print(f"  Ï†ÑÏ≤¥: {len(yahoo_data) + len(yayongsa_data)}Í∞ú ÏÉÅÌíà")

    # ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
    yahoo_stats = calculate_stats(yahoo_data, 'yahoo')
    yayongsa_stats = calculate_stats(yayongsa_data, 'yayongsa')

    # HTML ÎåÄÏãúÎ≥¥Îìú ÏÉùÏÑ±
    html_content = generate_dashboard_html(yahoo_data, yayongsa_data, yahoo_stats, yayongsa_stats)

    # ÌååÏùº Ï†ÄÏû•
    os.makedirs('dashboards', exist_ok=True)
    dashboard_file = 'dashboards/integrated_full.html'

    with open(dashboard_file, 'w', encoding='utf-8') as f:
        f.write(html_content)

    print(f"\n‚úÖ ÎåÄÏãúÎ≥¥Îìú ÏÉùÏÑ± ÏôÑÎ£å: {dashboard_file}")

    # admin ÏÇ¨Ïö©Ïûê Ìè¥ÎçîÏóêÎèÑ Î≥µÏÇ¨
    admin_dashboard_dir = 'users/admin/dashboards'
    if os.path.exists('users/admin'):
        os.makedirs(admin_dashboard_dir, exist_ok=True)
        admin_dashboard_file = f'{admin_dashboard_dir}/integrated_full.html'
        with open(admin_dashboard_file, 'w', encoding='utf-8') as f:
            f.write(html_content)
        print(f"‚úÖ Admin ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏: {admin_dashboard_file}")

    return dashboard_file

def calculate_stats(data, source):
    """Îç∞Ïù¥ÌÑ∞ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞"""
    stats = {
        'total': len(data),
        'positions': defaultdict(int),
        'brands': defaultdict(int),
        'conditions': defaultdict(int),
        'price_ranges': defaultdict(int),
        'avg_price': 0
    }

    if not data:
        return stats

    total_price = 0
    valid_price_count = 0

    for item in data:
        # Ìè¨ÏßÄÏÖò
        position = item.get('position', 'Ïò¨ÎùºÏö¥Îìú')
        stats['positions'][position] += 1

        # Î∏åÎûúÎìú
        brand = item.get('brand', 'Í∏∞ÌÉÄ')
        if brand and brand != 'unknown':
            stats['brands'][brand] += 1

        # ÏÉÅÌÉú
        condition = item.get('condition', 'ÎØ∏Î∂ÑÎ•ò')
        stats['conditions'][condition] += 1

        # Í∞ÄÍ≤©
        if source == 'yahoo':
            price = item.get('total_cost_krw', 0)
        else:
            price = item.get('price', 0)

        if price > 0:
            total_price += price
            valid_price_count += 1

            # Í∞ÄÍ≤©ÎåÄ
            if price <= 100000:
                price_range = '~10ÎßåÏõê'
            elif price <= 300000:
                price_range = '10~30ÎßåÏõê'
            elif price <= 500000:
                price_range = '30~50ÎßåÏõê'
            else:
                price_range = '50ÎßåÏõê~'
            stats['price_ranges'][price_range] += 1

    if valid_price_count > 0:
        stats['avg_price'] = total_price / valid_price_count

    return stats

def generate_dashboard_html(yahoo_data, yayongsa_data, yahoo_stats, yayongsa_stats):
    """ÎåÄÏãúÎ≥¥Îìú HTML ÏÉùÏÑ±"""

    # ÏÉÅÏúÑ Î∏åÎûúÎìú Ï∂îÏ∂ú
    top_yahoo_brands = dict(sorted(yahoo_stats['brands'].items(), key=lambda x: x[1], reverse=True)[:5])
    top_yayongsa_brands = dict(sorted(yayongsa_stats['brands'].items(), key=lambda x: x[1], reverse=True)[:5])

    html_content = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∏ÄÎü¨Î∏å ÎßàÏºì ÌÜµÌï© ÎåÄÏãúÎ≥¥Îìú</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}

        body {{
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }}

        .dashboard {{
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }}

        h1 {{
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }}

        .summary-section {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }}

        .summary-card {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }}

        .summary-label {{
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }}

        .summary-value {{
            font-size: 2.2em;
            font-weight: bold;
        }}

        .market-section {{
            margin-bottom: 40px;
        }}

        .market-title {{
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }}

        .charts-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }}

        .chart-container {{
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }}

        .chart-title {{
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
        }}

        canvas {{
            max-height: 250px !important;
        }}

        .products-section {{
            margin-top: 40px;
        }}

        .products-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }}

        .product-card {{
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }}

        .product-card:hover {{
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-color: #667eea;
        }}

        .product-title {{
            font-weight: bold;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
            min-height: 2.6em;
        }}

        .product-price {{
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin: 8px 0;
        }}

        .product-info {{
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            border-top: 1px solid #f0f0f0;
            padding-top: 8px;
        }}

        .timestamp {{
            text-align: center;
            color: #999;
            margin-top: 30px;
            font-size: 0.9em;
        }}
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>‚öæ Í∏ÄÎü¨Î∏å ÎßàÏºì ÌÜµÌï© ÎåÄÏãúÎ≥¥Îìú</h1>

        <!-- ÏöîÏïΩ ÏÑπÏÖò -->
        <div class="summary-section">
            <div class="summary-card">
                <div class="summary-label">Yahoo ÏÉÅÌíà</div>
                <div class="summary-value">{yahoo_stats['total']:,}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">ÏïºÏö©ÏÇ¨ ÏÉÅÌíà</div>
                <div class="summary-value">{yayongsa_stats['total']:,}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Ï†ÑÏ≤¥ ÏÉÅÌíà</div>
                <div class="summary-value">{yahoo_stats['total'] + yayongsa_stats['total']:,}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Yahoo ÌèâÍ∑†Í∞Ä</div>
                <div class="summary-value">‚Ç©{int(yahoo_stats['avg_price']):,}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">ÏïºÏö©ÏÇ¨ ÌèâÍ∑†Í∞Ä</div>
                <div class="summary-value">‚Ç©{int(yayongsa_stats['avg_price']):,}</div>
            </div>
        </div>

        <!-- Yahoo Auction ÏÑπÏÖò -->
        <div class="market-section">
            <h2 class="market-title">üáØüáµ Yahoo Auction Japan ({yahoo_stats['total']}Í∞ú)</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Ìè¨ÏßÄÏÖòÎ≥Ñ Î∂ÑÌè¨</div>
                    <canvas id="yahooPosition"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Í∞ÄÍ≤©ÎåÄ Î∂ÑÌè¨</div>
                    <canvas id="yahooPrice"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ÏÉÅÌÉúÎ≥Ñ Î∂ÑÌè¨</div>
                    <canvas id="yahooCondition"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Î∏åÎûúÎìú TOP 5</div>
                    <canvas id="yahooBrand"></canvas>
                </div>
            </div>
        </div>

        <!-- ÏïºÏö©ÏÇ¨ ÏÑπÏÖò -->
        <div class="market-section">
            <h2 class="market-title">üá∞üá∑ ÏïºÏö©ÏÇ¨ Ïπ¥Ìéò ({yayongsa_stats['total']}Í∞ú)</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Ìè¨ÏßÄÏÖòÎ≥Ñ Î∂ÑÌè¨</div>
                    <canvas id="yayongsaPosition"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Í∞ÄÍ≤©ÎåÄ Î∂ÑÌè¨</div>
                    <canvas id="yayongsaPrice"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ÏÉÅÌÉúÎ≥Ñ Î∂ÑÌè¨</div>
                    <canvas id="yayongsaCondition"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Î∏åÎûúÎìú TOP 5</div>
                    <canvas id="yayongsaBrand"></canvas>
                </div>
            </div>
        </div>

        <!-- ÏÉÅÌíà ÎØ∏Î¶¨Î≥¥Í∏∞ -->
        <div class="products-section">
            <h2 class="market-title">üì¶ ÏµúÍ∑º ÏÉÅÌíà ÎØ∏Î¶¨Î≥¥Í∏∞</h2>
            <div class="products-grid">
"""

    # Yahoo ÏÉÅÌíà Ïπ¥Îìú (ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨ ÌõÑ ÏµúÎåÄ 8Í∞ú)
    # ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÍ∞Ä ÏûàÏúºÎ©¥ Ï†ïÎ†¨, ÏóÜÏúºÎ©¥ Ïó≠ÏàúÏúºÎ°ú
    sorted_yahoo = sorted(yahoo_data, key=lambda x: x.get('timestamp', ''), reverse=True) if yahoo_data else []

    for item in sorted_yahoo[:8]:
        # ÏóîÌôî Í∞ÄÍ≤© ÏÇ¨Ïö© (1Ïóî = ÏïΩ 9.2Ïõê)
        price_yen = item.get('current_price', 0)
        # total_cost_krwÏóêÎäî Î∞∞ÏÜ°ÎπÑ Ìè¨Ìï®Îêú Í∞ÄÍ≤©Ïù¥ ÏûàÏùÑ Ïàò ÏûàÏùå
        price_krw = item.get('total_cost_krw', 0)
        if not price_krw and price_yen:
            price_krw = price_yen * 9.2  # ÌôòÏú® Ï†ÅÏö©
        position = item.get('position', 'Ïò¨ÎùºÏö¥Îìú')
        brand = item.get('brand', 'Í∏∞ÌÉÄ')
        condition = item.get('condition', 'ÎØ∏Î∂ÑÎ•ò')

        html_content += f"""
                <div class="product-card" onclick="window.open('{item.get('url', '#')}', '_blank')">
                    <div class="product-title">{item.get('title', '')[:40]}...</div>
                    <div class="product-price">¬•{price_yen:,}</div>
                    <div class="product-info" style="font-size: 0.85em; color: #888;">ÏïΩ ‚Ç©{int(price_krw):,}</div>
                    <div class="product-info">Yahoo | {position} | {brand} | {condition}</div>
                </div>
"""

    # ÏïºÏö©ÏÇ¨ ÏÉÅÌíà Ïπ¥Îìú (ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨ ÌõÑ ÏµúÎåÄ 4Í∞ú)
    sorted_yayongsa = sorted(yayongsa_data, key=lambda x: x.get('date', ''), reverse=True) if yayongsa_data else []

    for item in sorted_yayongsa[:4]:
        price = item.get('price', 0)
        position = item.get('position', 'Ïò¨ÎùºÏö¥Îìú')
        condition = item.get('condition', 'Ï§ëÍ≥†')

        html_content += f"""
                <div class="product-card" onclick="window.open('{item.get('url', '#')}', '_blank')">
                    <div class="product-title">{item.get('title', '')[:40]}...</div>
                    <div class="product-price">‚Ç©{price:,}</div>
                    <div class="product-info" style="margin-top: 10px;">ÏïºÏö©ÏÇ¨ | {position} | {condition}</div>
                </div>
"""

    html_content += f"""
            </div>
        </div>

        <div class="timestamp">
            ÏóÖÎç∞Ïù¥Ìä∏: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        </div>
    </div>

    <script>
        // Chart.js Í∏∞Î≥∏ ÏÑ§Ï†ï
        Chart.defaults.plugins.legend.position = 'bottom';

        // Yahoo Ìè¨ÏßÄÏÖò Ï∞®Ìä∏
        new Chart(document.getElementById('yahooPosition'), {{
            type: 'doughnut',
            data: {{
                labels: {list(yahoo_stats['positions'].keys())},
                datasets: [{{
                    data: {list(yahoo_stats['positions'].values())},
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }}]
            }}
        }});

        // Yahoo Í∞ÄÍ≤©ÎåÄ Ï∞®Ìä∏
        new Chart(document.getElementById('yahooPrice'), {{
            type: 'bar',
            data: {{
                labels: ['~10ÎßåÏõê', '10~30ÎßåÏõê', '30~50ÎßåÏõê', '50ÎßåÏõê~'],
                datasets: [{{
                    label: 'ÏÉÅÌíà Ïàò',
                    data: [{yahoo_stats['price_ranges'].get('~10ÎßåÏõê', 0)},
                           {yahoo_stats['price_ranges'].get('10~30ÎßåÏõê', 0)},
                           {yahoo_stats['price_ranges'].get('30~50ÎßåÏõê', 0)},
                           {yahoo_stats['price_ranges'].get('50ÎßåÏõê~', 0)}],
                    backgroundColor: '#667eea'
                }}]
            }},
            options: {{
                scales: {{ y: {{ beginAtZero: true }} }}
            }}
        }});

        // Yahoo ÏÉÅÌÉú Ï∞®Ìä∏
        new Chart(document.getElementById('yahooCondition'), {{
            type: 'pie',
            data: {{
                labels: {list(yahoo_stats['conditions'].keys())},
                datasets: [{{
                    data: {list(yahoo_stats['conditions'].values())},
                    backgroundColor: ['#4BC0C0', '#FFCE56', '#FF6384']
                }}]
            }}
        }});

        // Yahoo Î∏åÎûúÎìú Ï∞®Ìä∏
        new Chart(document.getElementById('yahooBrand'), {{
            type: 'doughnut',
            data: {{
                labels: {list(top_yahoo_brands.keys())},
                datasets: [{{
                    data: {list(top_yahoo_brands.values())},
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }}]
            }}
        }});

        // ÏïºÏö©ÏÇ¨ Ìè¨ÏßÄÏÖò Ï∞®Ìä∏
        new Chart(document.getElementById('yayongsaPosition'), {{
            type: 'doughnut',
            data: {{
                labels: {list(yayongsa_stats['positions'].keys())},
                datasets: [{{
                    data: {list(yayongsa_stats['positions'].values())},
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }}]
            }}
        }});

        // ÏïºÏö©ÏÇ¨ Í∞ÄÍ≤©ÎåÄ Ï∞®Ìä∏
        new Chart(document.getElementById('yayongsaPrice'), {{
            type: 'bar',
            data: {{
                labels: ['~10ÎßåÏõê', '10~30ÎßåÏõê', '30~50ÎßåÏõê', '50ÎßåÏõê~'],
                datasets: [{{
                    label: 'ÏÉÅÌíà Ïàò',
                    data: [{yayongsa_stats['price_ranges'].get('~10ÎßåÏõê', 0)},
                           {yayongsa_stats['price_ranges'].get('10~30ÎßåÏõê', 0)},
                           {yayongsa_stats['price_ranges'].get('30~50ÎßåÏõê', 0)},
                           {yayongsa_stats['price_ranges'].get('50ÎßåÏõê~', 0)}],
                    backgroundColor: '#764ba2'
                }}]
            }},
            options: {{
                scales: {{ y: {{ beginAtZero: true }} }}
            }}
        }});

        // ÏïºÏö©ÏÇ¨ ÏÉÅÌÉú Ï∞®Ìä∏
        new Chart(document.getElementById('yayongsaCondition'), {{
            type: 'pie',
            data: {{
                labels: {list(yayongsa_stats['conditions'].keys())},
                datasets: [{{
                    data: {list(yayongsa_stats['conditions'].values())},
                    backgroundColor: ['#4BC0C0', '#FFCE56', '#FF6384']
                }}]
            }}
        }});

        // ÏïºÏö©ÏÇ¨ Î∏åÎûúÎìú Ï∞®Ìä∏
        new Chart(document.getElementById('yayongsaBrand'), {{
            type: 'doughnut',
            data: {{
                labels: {list(top_yayongsa_brands.keys())},
                datasets: [{{
                    data: {list(top_yayongsa_brands.values())},
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }}]
            }}
        }});
    </script>
</body>
</html>
"""

    return html_content

if __name__ == "__main__":
    dashboard_file = update_integrated_dashboard()
    import webbrowser
    webbrowser.open(f'file:///{os.path.abspath(dashboard_file)}')